<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Face Detector & Suara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat face-api.js dari CDN -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Efek Console Log ala Hacker */
        .console-text {
            font-family: 'Courier New', Courier, monospace;
        }
        /* Scrollbar kustom */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4ade80;
            border-radius: 4px;
        }
        /* Positioning canvas di atas video */
        #video-container {
            position: relative;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header -->
    <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-green-400 mb-2">AI Face Detector</h1>
        <p class="text-gray-400 text-sm">Pastikan volume aktif untuk mendengar suara notifikasi.</p>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-6xl">
        
        <!-- Kolom Kiri: Video Feed -->
        <div class="flex flex-col items-center">
            <div id="video-container" class="rounded-lg overflow-hidden shadow-2xl border-2 border-green-500 bg-black w-full max-w-md aspect-[4/3] relative">
                <!-- Loading Spinner -->
                <div id="loading" class="absolute inset-0 flex items-center justify-center bg-gray-900 z-50">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
                    <span class="ml-3 text-green-500 font-mono animate-pulse">Memuat Model AI...</span>
                </div>
                
                <video id="video" class="w-full h-full object-cover transform scale-x-[-1]" autoplay muted playsinline></video>
                <!-- Canvas akan di-inject oleh script di sini -->
            </div>
            
            <div class="mt-4 flex gap-2">
                <div id="status-indicator" class="px-4 py-2 rounded bg-red-600 text-white font-bold transition-colors duration-300">
                    Tidak Ada Wajah
                </div>
            </div>
        </div>

        <!-- Kolom Kanan: System Log -->
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-xl flex flex-col h-[400px] lg:h-auto">
            <div class="flex justify-between items-center mb-2 border-b border-gray-700 pb-2">
                <h2 class="text-green-400 font-mono text-lg flex items-center">
                    <span class="mr-2">$_</span> SYSTEM LOG
                </h2>
                <button onclick="clearLogs()" class="text-xs text-gray-400 hover:text-white underline">Bersihkan</button>
            </div>
            <div id="console-logs" class="flex-1 overflow-y-auto font-mono text-xs space-y-1 p-2 bg-black rounded border border-gray-700 text-green-500/80">
                <!-- Log akan muncul di sini -->
                <div class="text-yellow-500">[SYSTEM] Menunggu inisialisasi...</div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const videoContainer = document.getElementById('video-container');
        const loadingScreen = document.getElementById('loading');
        const statusIndicator = document.getElementById('status-indicator');
        const logContainer = document.getElementById('console-logs');

        let isModelLoaded = false;
        let isFaceDetectedState = false; // State tracking untuk mencegah spam suara
        let canvas;

        // URL Model (menggunakan GitHub Pages dari pembuat face-api.js agar stabil)
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        // Fungsi Log ke Layar
        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            
            if (type === 'error') div.className = 'text-red-500';
            else if (type === 'success') div.className = 'text-green-400 font-bold';
            else if (type === 'warn') div.className = 'text-yellow-400';
            else div.className = 'text-green-500/80';

            div.innerHTML = `<span class="opacity-50">[${time}]</span> ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight; // Auto scroll ke bawah
        }

        function clearLogs() {
            logContainer.innerHTML = '';
            addLog('Log dibersihkan.', 'warn');
        }

        // Fungsi Text-to-Speech (Suara Google)
        function speak(text) {
            if (!window.speechSynthesis) {
                addLog("Browser tidak mendukung Text-to-Speech", 'error');
                return;
            }

            // Batalkan suara sebelumnya agar tidak tumpang tindih
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID'; // Bahasa Indonesia
            utterance.rate = 1; // Kecepatan normal
            utterance.pitch = 1;
            
            // Fallback jika suara ID tidak ditemukan, gunakan default
            const voices = window.speechSynthesis.getVoices();
            const indoVoice = voices.find(v => v.lang.includes('id'));
            if (indoVoice) utterance.voice = indoVoice;

            window.speechSynthesis.speak(utterance);
            addLog(`ðŸ”Š Audio: "${text}"`, 'warn');
        }

        // 1. Memuat Model AI
        async function loadModels() {
            addLog("Memulai memuat model TinyFaceDetector...", 'info');
            try {
                // Kita load TinyFaceDetector (ringan) dan FaceLandmark (untuk kotak wajah)
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                
                isModelLoaded = true;
                addLog("Model AI berhasil dimuat!", 'success');
                loadingScreen.style.display = 'none';
                startVideo();
            } catch (error) {
                console.error(error);
                addLog("Gagal memuat model. Cek koneksi internet.", 'error');
                loadingScreen.innerHTML = '<span class="text-red-500">Gagal memuat model. Refresh halaman.</span>';
            }
        }

        // 2. Mengakses Webcam
        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    addLog("Webcam aktif.", 'success');
                })
                .catch(err => {
                    console.error(err);
                    addLog("Gagal akses kamera: " + err, 'error');
                    loadingScreen.style.display = 'flex';
                    loadingScreen.innerHTML = '<span class="text-red-500">Izin kamera ditolak.</span>';
                });
        }

        // 3. Event Listener saat Video Play
        video.addEventListener('play', () => {
            // Membuat Canvas Overlay
            canvas = faceapi.createCanvasFromMedia(video);
            videoContainer.append(canvas);
            
            const displaySize = { width: video.videoWidth || 640, height: video.videoHeight || 480 };
            faceapi.matchDimensions(canvas, displaySize);

            // Perbaiki ukuran canvas saat window di resize
            const updateCanvasSize = () => {
                const rect = video.getBoundingClientRect();
                faceapi.matchDimensions(canvas, { width: rect.width, height: rect.height });
            };
            
            // Loop Deteksi
            setInterval(async () => {
                if (!isModelLoaded) return;

                // Memastikan ukuran canvas sinkron dengan video visual
                const displayedSize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(canvas, displayedSize);

                // Deteksi Wajah
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                
                // Menggambar kotak deteksi
                const resizedDetections = faceapi.resizeResults(detections, displayedSize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, resizedDetections);

                // Logika Status & Suara
                if (detections.length > 0) {
                    if (!isFaceDetectedState) {
                        // Perubahan Status: Tidak Ada -> Ada
                        statusIndicator.innerText = "WAJAH TERDETEKSI";
                        statusIndicator.className = "px-4 py-2 rounded bg-green-600 text-white font-bold transition-colors duration-300 shadow-lg shadow-green-500/50";
                        addLog(`Wajah terdeteksi! (Score: ${Math.round(detections[0].score * 100)}%)`, 'success');
                        speak("Wajah terdeteksi");
                        isFaceDetectedState = true;
                    }
                } else {
                    if (isFaceDetectedState) {
                        // Perubahan Status: Ada -> Tidak Ada
                        statusIndicator.innerText = "WAJAH TAK TERDETEKSI";
                        statusIndicator.className = "px-4 py-2 rounded bg-red-600 text-white font-bold transition-colors duration-300";
                        addLog("Wajah hilang dari pandangan.", 'warn');
                        speak("Wajah tak terdeteksi");
                        isFaceDetectedState = false;
                    }
                }

            }, 200); // Cek setiap 200ms
        });

        // Start
        // Pre-load voices for Chrome bug
        window.speechSynthesis.getVoices();
        loadModels();

    </script>
</body>
</html>

