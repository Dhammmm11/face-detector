<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face AI V12 - Best Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .camera-wrapper {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #raw-video { display: none; }
        #output-canvas {
            width: 100%;
            height: auto;
            display: block;
            background-color: #1a1a1a;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-gray-800/90 backdrop-blur border-b border-gray-700 p-3 sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="fas fa-eye text-green-400"></i>
            <h1 class="font-bold text-sm md:text-lg">FaceGuard <span class="text-[10px] bg-green-900/50 text-green-300 px-1 rounded">V12 FINAL</span></h1>
        </div>
        <div id="status-text" class="text-xs font-mono text-gray-400 font-bold">SYSTEM READY</div>
    </nav>

    <!-- Start Screen -->
    <div id="start-screen" class="fixed inset-0 bg-gray-900 z-[100] flex flex-col items-center justify-center p-6 text-center">
        <button onclick="startSystem()" class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center border-2 border-green-500 hover:scale-110 transition-transform mb-4 shadow-[0_0_40px_rgba(34,197,94,0.4)] group">
            <i class="fas fa-power-off text-4xl text-green-500 group-hover:text-green-300 transition-colors"></i>
        </button>
        <h2 class="text-xl font-bold">Mulai Sistem V12</h2>
        <p class="text-xs text-gray-500 mt-2 max-w-xs">Visual Futuristik + Logika Audio Anti-Error.</p>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto p-4 flex flex-col gap-4 max-w-4xl">
        
        <div class="flex flex-col md:flex-row gap-4">
            
            <!-- KIRI: Kamera -->
            <div class="flex-1 relative">
                <div class="camera-wrapper border border-gray-700 group" id="cam-container">
                    <video id="raw-video" playsinline muted autoplay></video>
                    <canvas id="output-canvas"></canvas>

                    <!-- Status Badge -->
                    <div class="absolute top-3 left-3 z-10">
                        <span id="status-badge" class="bg-red-600/90 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg backdrop-blur">
                            OFFLINE
                        </span>
                    </div>

                    <!-- Switch Cam -->
                    <button onclick="switchCamera()" class="absolute top-3 right-3 bg-black/40 hover:bg-black/70 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center backdrop-blur z-20 transition-all border border-white/10">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>

                    <!-- Loading -->
                    <div id="loading-spinner" class="absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-30 hidden">
                        <div class="w-10 h-10 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-2"></div>
                        <span class="text-green-500 text-xs font-mono">LOADING AI...</span>
                    </div>
                </div>
            </div>

            <!-- KANAN: Panel Counter -->
            <div class="w-full md:w-64 flex flex-col gap-3">
                <div class="bg-gray-800 rounded-2xl border border-gray-700 p-6 flex flex-col items-center justify-center h-full min-h-[150px] relative overflow-hidden group">
                    <div class="absolute inset-0 bg-green-500/5 group-hover:bg-green-500/10 transition-colors"></div>
                    <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2 z-10">Total Wajah</h3>
                    <div class="flex items-baseline z-10">
                        <span id="big-counter" class="text-6xl font-black text-white tracking-tighter transition-all duration-300">0</span>
                    </div>
                    <div id="active-indicator" class="mt-4 flex items-center gap-2 opacity-0 transition-opacity duration-500">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-[10px] text-green-400 font-mono">Live Tracking</span>
                    </div>
                </div>

                <div class="bg-black rounded-lg border border-gray-800 p-2 h-32 overflow-y-auto font-mono text-[10px] space-y-1 scrollbar-hide" id="sys-log">
                    <div class="text-gray-500">> System Ready.</div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Config ---
        const CONFIDENCE_THRESHOLD = 0.65;
        const GRACE_PERIOD_MS = 500; // Toleransi waktu agar audio tidak error

        // --- Audio ---
        const audioFound = new Audio('https://files.catbox.moe/5fvi1g.mp3');
        const audioLost = new Audio('https://files.catbox.moe/2un54s.mp3');
        audioFound.volume = 1.0; audioLost.volume = 1.0;

        // --- Elements ---
        const video = document.getElementById('raw-video');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d');
        const sysLog = document.getElementById('sys-log');
        const statusBadge = document.getElementById('status-badge');
        const loadingSpinner = document.getElementById('loading-spinner');
        const bigCounter = document.getElementById('big-counter');
        const activeIndicator = document.getElementById('active-indicator');
        const navStatus = document.getElementById('status-text');

        let faceDetection = null;
        let isSystemActive = false;
        let lastDetections = [];
        
        let isFaceCurrentlyDetected = false;
        let lossTimer = null; 
        let isSwitchingCamera = false;
        let currentFacingMode = 'user';
        let lastAudioTime = 0;

        // --- Audio Manager ---
        function playAudio(type) {
            const now = Date.now();
            if (now - lastAudioTime < 1000) return;
            audioFound.pause(); audioFound.currentTime = 0;
            audioLost.pause(); audioLost.currentTime = 0;
            const sound = type === 'found' ? audioFound : audioLost;
            sound.play().catch(e => console.warn(e));
            lastAudioTime = now;
        }

        // --- Switch Camera ---
        async function switchCamera() {
            if (isSwitchingCamera) return;
            isSwitchingCamera = true;
            loadingSpinner.classList.remove('hidden');
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { exact: currentFacingMode }, width: { ideal: 640 }, height: { ideal: 480 } }, audio: false
                });
                await handleNewStream(stream);
            } catch (err) {
                try {
                    const fallback = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode }, audio: false });
                    await handleNewStream(fallback);
                } catch (e) { alert("Error"); }
            }
        }

        async function handleNewStream(stream) {
            video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = r);
            await video.play();
            loadingSpinner.classList.add('hidden');
            isSwitchingCamera = false;
        }

        function uiLog(msg, color) {
            const div = document.createElement('div');
            div.className = `${color} border-b border-gray-800 pb-1`;
            div.innerHTML = `<span class="text-gray-600 mr-2">[${new Date().toLocaleTimeString('id-ID', {hour12:false})}]</span>${msg}`;
            sysLog.prepend(div);
        }

        // --- AI LOGIC (Anti-Flicker) ---
        function onAiResult(results) {
            lastDetections = results.detections;
            const count = lastDetections.length;

            bigCounter.innerText = count;
            if (count > 0) {
                bigCounter.classList.remove('text-white');
                bigCounter.classList.add('text-green-400', 'scale-110');
                activeIndicator.style.opacity = '1';
                
                if (lossTimer) { clearTimeout(lossTimer); lossTimer = null; }
                if (!isFaceCurrentlyDetected) {
                    isFaceCurrentlyDetected = true;
                    handleStateChange(true);
                }
            } else {
                bigCounter.classList.add('text-white');
                bigCounter.classList.remove('text-green-400', 'scale-110');
                activeIndicator.style.opacity = '0';

                if (isFaceCurrentlyDetected && !lossTimer) {
                    lossTimer = setTimeout(() => {
                        isFaceCurrentlyDetected = false;
                        handleStateChange(false);
                        lossTimer = null;
                    }, GRACE_PERIOD_MS); 
                }
            }
        }

        function handleStateChange(isDetected) {
            if (isDetected) {
                statusBadge.className = "bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-[0_0_15px_rgba(34,197,94,0.8)] transition-all";
                statusBadge.innerText = "TARGET LOCKED";
                navStatus.innerText = "WAJAH TERDETEKSI";
                navStatus.className = "text-xs font-mono text-green-400 font-bold animate-pulse";
                playAudio('found');
                uiLog("Wajah Terdeteksi", "text-green-400");
            } else {
                statusBadge.className = "bg-red-600/90 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg transition-all";
                statusBadge.innerText = "SEARCHING...";
                navStatus.innerText = "MENCARI SUBJEK...";
                navStatus.className = "text-xs font-mono text-gray-400 font-bold";
                playAudio('lost');
                uiLog("Wajah Hilang", "text-red-400");
            }
        }

        // --- Render Loop ---
        function renderLoop() {
            if (!isSystemActive) return;
            if (video.readyState === 4 && !isSwitchingCamera) {
                if (canvas.width !== video.videoWidth) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }
                
                ctx.save();
                if (currentFacingMode === 'user') {
                    ctx.translate(canvas.width, 0);
                    ctx.scale(-1, 1);
                }
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.restore();

                if (lastDetections.length > 0) drawCorners(lastDetections);
            }
            requestAnimationFrame(renderLoop);
        }

        function drawCorners(dets) {
            dets.forEach(det => {
                const box = det.boundingBox;
                
                // Koordinat X harus dibalik manual jika sedang mode Selfie (Mirror)
                let x = box.xCenter * canvas.width - (box.width * canvas.width / 2);
                if (currentFacingMode === 'user') {
                    x = canvas.width - (x + (box.width * canvas.width)); 
                }
                
                const y = box.yCenter * canvas.height - (box.height * canvas.height / 2);
                const w = box.width * canvas.width;
                const h = box.height * canvas.height;
                const cl = Math.min(w, h) * 0.25; // Panjang sudut

                // Style Neon Green (Cyberpunk)
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 10;

                ctx.beginPath();
                // Gambar 4 Sudut
                ctx.moveTo(x, y + cl); ctx.lineTo(x, y); ctx.lineTo(x + cl, y); // Kiri Atas
                ctx.moveTo(x + w - cl, y); ctx.lineTo(x + w, y); ctx.lineTo(x + w, y + cl); // Kanan Atas
                ctx.moveTo(x + w, y + h - cl); ctx.lineTo(x + w, y + h); ctx.lineTo(x + w - cl, y + h); // Kanan Bawah
                ctx.moveTo(x + cl, y + h); ctx.lineTo(x, y + h); ctx.lineTo(x, y + h - cl); // Kiri Bawah
                ctx.stroke();

                ctx.shadowBlur = 0; // Reset shadow

                // Label Background
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(x, y - 24, 60, 20);
                
                // Text
                ctx.fillStyle = '#00ff00';
                ctx.font = 'bold 12px monospace';
                ctx.fillText(`ID: ${(det.score*100).toFixed(0)}%`, x + 5, y - 10);
            });
        }

        async function startSystem() {
            document.getElementById('start-screen').style.display = 'none';
            loadingSpinner.classList.remove('hidden');
            
            // Warmup Audio
            audioFound.play().then(() => { audioFound.pause(); audioFound.currentTime=0; }).catch(() => {});
            audioLost.play().then(() => { audioLost.pause(); audioLost.currentTime=0; }).catch(() => {});

            try {
                faceDetection = new FaceDetection({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`});
                faceDetection.setOptions({ model: 'short', minDetectionConfidence: CONFIDENCE_THRESHOLD });
                faceDetection.onResults(onAiResult);
                await faceDetection.initialize();

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }, audio: false
                });
                await handleNewStream(stream);

                isSystemActive = true;
                requestAnimationFrame(renderLoop);
                setInterval(async () => {
                     if (isSystemActive && video.readyState === 4 && !isSwitchingCamera) {
                         try { await faceDetection.send({image: video}); } catch (e) {}
                     }
                }, 100);

            } catch (e) { alert("Error: " + e.message); location.reload(); }
        }
    </script>
</body>
</html>


